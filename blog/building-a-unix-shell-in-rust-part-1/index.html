<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
Building a Unix-shell in Rust - Part 1 &middot; T.J. Telan
</title>

  <!-- CSS -->
  <link rel="stylesheet" href="https://tjtelan.com/print.css" media="print">
  <link rel="stylesheet" href="https://tjtelan.com/tj.css">
  <!--<link rel="stylesheet" href="https://tjtelan.com/newsletter.css">-->
  <link rel="stylesheet" href="https://tjtelan.com/hyde.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

  
  
  <link rel="alternate" type="application/atom+xml" title="Atom" href="https://tjtelan.com/atom.xml">
  
  
  
  <!-- Facebook open graph tags-->
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://tjtelan.com/blog/building-a-unix-shell-in-rust-part-1/" />
   
  <meta property="og:title" content="Building a Unix-shell in Rust - Part 1" />
  
  
  <meta property="og:description" content="Description of concepts of a Unix shell" />
  
  <!-- Twitter card tags -->
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:url" content="https://tjtelan.com/blog/building-a-unix-shell-in-rust-part-1/" />
   
  <meta name="twitter:title" content="Building a Unix-shell in Rust - Part 1" />
  
  
  <meta name="twitter:description" content="Description of concepts of a Unix shell" />
  
  <meta name="twitter:creator" content="@ThatTJTelan" />
  <meta name="twitter:site" content="@ThatTJTelan" />

  
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-M280GK01DY"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-M280GK01DY');
</script>


<!-- Plausible Analytics -->
<script defer data-domain="tjtelan.com" src="https://analytics.analogorithm.net/js/script.js"></script>

</head>

<body class=" ">
  
  <div  id="sidebar" class="sidebar">
    <div class="container sidebar-sticky">
      <div class="sidebar-about">
        
        <a href="https://tjtelan.com">
          <h1>T.J. Telan</h1>
        </a>
        
        <p class="lede">Practical DevOps &amp; Developer Experience</p>
        
        
      </div>

      <ul class="sidebar-nav">
        
          
            
            <li class="sidebar-nav-item">
              <a href="/now/">Now</a>
            </li>
            
          
            
            <li class="sidebar-nav-item">
              <a href="/about/">About</a>
            </li>
            
          
            
            <li class="sidebar-nav-item">
              <a href="https://github.com/tjtelan">Github<img src="/nav-icons/github.svg" alt="Github"></a>
            </li>
            
          
            
            <li class="sidebar-nav-item">
              <a href="https://dev.to/tjtelan">Dev.to<img src="/nav-icons/dev-dot-to.svg" alt="Dev.to"></a>
            </li>
            
          
            
            <li class="sidebar-nav-item">
              <a href="https://medium.com/@tjtelan">Medium<img src="/nav-icons/medium.svg" alt="Medium"></a>
            </li>
            
          
            
            <li class="sidebar-nav-item">
              <a href="https://twitter.com/ThatTJTelan">Twitter<img src="/nav-icons/twitter.svg" alt="Twitter"></a>
            </li>
            
          
            
            <li class="sidebar-nav-item">
              <a href="https://www.twitch.tv/tjtelan">Twitch<img src="/nav-icons/twitch.svg" alt="Twitch"></a>
            </li>
            
          
            
            <li class="sidebar-nav-item">
              <a href="https://www.youtube.com/channel/UCiwV2NFMF26A5nfakQbuZ-g">YouTube<img src="/nav-icons/youtube.svg" alt="YouTube"></a>
            </li>
            
          
            
            <li class="sidebar-nav-item">
              <a href="/atom.xml">RSS<img src="/nav-icons/rss.svg" alt="RSS"></a>
            </li>
            
          
        
      </ul>
    </div>
  </div>
  

  <div class="content container">
    
<div class="post">
    <h1 class="post-title">Building a Unix-shell in Rust - Part 1</h1>
    
    <span class="post-meta">
        6 min read
        &nbsp;&bull;&nbsp;
        2017-11-05
        
          &nbsp;&bull;
          
          &nbsp;
          <a  href="https://tjtelan.com/categories/how-to/">
              how-to
            </a>
          
        
        
          &nbsp;&bull;
          
          &nbsp;
          <a  href="https://tjtelan.com/tags/rust/">
              #rust
            </a>
          
        
      </span>

    <p>My goal is to find more work opportunities to write in Rust the same way I can write in Python and Go. Since I spend a lot of time designing and executing automation, it felt useful to start somewhere familiar. How about a simple Unix shell? Yes, I use bash all the time.</p>
<p>Rather than get this all worked out before posting, I'm going to document as much of my thought process in the design, as I have it. (But I am editing this to spare you the noisier stream-of-consciousness experience.)</p>
<p>I'll have code snippets occasionally, but I'm trying to keep the audience around intermediate experience (where I consider myself to be today). I'm going to assume you use another programming language today to Get Shit Done, and use the terminal to do simple things, but not necessarily write shell scripts.</p>
<p>Why am I doing this? I don't often see posts from beginning Rust learners doing practical, simple things (that can simply be copy/pasted and modified slightly), like in the other more mature language communities... Widest market? Probably not. </p>
<p>I guess that's enough rambling. Letâ€™s dive in.</p>
<hr />
<h2 id="what-s-a-shell">Whatâ€™s a shell?<a class="zola-anchor" href="#what-s-a-shell" aria-label="Anchor link for: what-s-a-shell">ðŸ”—</a></h2>
<p>A shell is an interactive language interpreter that allows you to run text-based commands and translates them into an action, such as making internal function calls, or running external programs.</p>
<p>You usually use it to access resources from the operating system. </p>
<p>Additional to accepting a text command - it typically outputs text results and/or causes some other side-effect.</p>
<p>You may know some of the name brand shells like the kind we're making, a Unix shell:</p>
<ul>
<li>Bourne-shell (sh)</li>
<li>bash</li>
<li>zsh</li>
<li>fish</li>
</ul>
<p>Or the windows specific:</p>
<ul>
<li>Command Prompt (cmd.exe)</li>
<li>Powershell</li>
</ul>
<p>Or interpreted languages:</p>
<ul>
<li>python </li>
<li>lua</li>
<li>haskell </li>
</ul>
<p>Shells run in terminal emulators. This is (over-) simplified as the text-only window that runs your shell. </p>
<p>It handles the interaction from you (known as Standard-In, like keystrokes) and your shell (known as Standard-Out for the buffered/flushed output style, and Standard-Error for the direct output style).</p>
<p>In most cases, the terminal emulator and shell are different processes (Windowsâ€™ cmd.exe and Powershell are confusingly, both the shell and terminal emulator) </p>
<p>You may have made reference to it by other common names such as:</p>
<ul>
<li>command prompt</li>
<li>terminal</li>
<li>console</li>
</ul>
<p>Examples of some terminal emulators</p>
<ul>
<li>xterm</li>
<li>rxvt</li>
<li>iTerm</li>
<li>Terminal.app</li>
<li>Windows Command Prompt</li>
<li>Powershell</li>
</ul>
<p>Iâ€™m going to focus on writing a bash-like shell. Functionality, and syntax should feel familiar. </p>
<hr />
<p>The shells are a <a rel="noopener nofollow" target="_blank" href="https://en.wikipedia.org/wiki/Read%E2%80%93eval%E2%80%93print_loop">REPL</a>, a Read-Eval-Print-Loop.</p>
<p>Typically, a character (letâ€™s say â€˜$â€™) is printed and a cursor blinks. This informs the user that a command can be typed in.</p>
<p>You type in a command.</p>
<p>You hit enter to translate the command into an action.</p>
<p>The output of the program prints to the screen.</p>
<pre data-lang="sh" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-sh "><code class="language-sh" data-lang="sh"><span>$ 
</span></code></pre>
<h3 id="what-does-this-mean-for-me">What does this mean for me?<a class="zola-anchor" href="#what-does-this-mean-for-me" aria-label="Anchor link for: what-does-this-mean-for-me">ðŸ”—</a></h3>
<p>It lets us quickly stub the code out into this REPL  pattern 
Our main function that will enter a loop. Inside the main loop, we request a command from the user, and do something. Then we do it all over again. </p>
<h2 id="breaking-down-the-steps">Breaking down the steps<a class="zola-anchor" href="#breaking-down-the-steps" aria-label="Anchor link for: breaking-down-the-steps">ðŸ”—</a></h2>
<h3 id="first-we-read">First we Read<a class="zola-anchor" href="#first-we-read" aria-label="Anchor link for: first-we-read">ðŸ”—</a></h3>
<p>We need to take user input. Most shells print a symbol to signal to the user that we can input a command (as opposed to, for example, executing a command). I need to learn how to get a text command from the user. </p>
<p>Let's start our definition of a command. </p>
<p><strong>Command</strong></p>
<blockquote>
<p>a series of words separated by spaces.</p>
</blockquote>
<pre data-lang="sh" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-sh "><code class="language-sh" data-lang="sh"><span>$ keyword arg1 arg2 arg3â€¦ 
</span></code></pre>
<p>The first word is a keyword. It's either a built-in function or an executable on the filesystem, with the rest of the line being parameters passed to our function. </p>
<p><strong>Keyword</strong></p>
<blockquote>
<p>One of 2 possibilities :</p>
<ul>
<li>A built-in function to the shell (that is, calling a function in the code)</li>
<li>An executable
<ul>
<li>Either in one of the directories in your PATH</li>
<li>Or a filesystem path (relative or absolute)</li>
</ul>
</li>
</ul>
</blockquote>
<h3 id="then-we-execute">Then we Execute<a class="zola-anchor" href="#then-we-execute" aria-label="Anchor link for: then-we-execute">ðŸ”—</a></h3>
<p>When we use a command that calls a built-in, we simply pass the arguments to the function, and return back to the start of the loop when it completes. </p>
<h4 id="and-when-we-call-an-executable">And when we call an executable?<a class="zola-anchor" href="#and-when-we-call-an-executable" aria-label="Anchor link for: and-when-we-call-an-executable">ðŸ”—</a></h4>
<p>We need to make a <a rel="noopener nofollow" target="_blank" href="https://en.m.wikipedia.org/wiki/Fork_(system_call)">fork</a> syscall, that is, create a new process for the executable to run in, so it can have its own memory space, and manage its own interactions with the operating system. (The shell is still the parent process) </p>
<p>To start a process inside the child process, we have to call the <a rel="noopener nofollow" target="_blank" href="https://en.m.wikipedia.org/wiki/Exec_(system_call)">exec</a> syscall. </p>
<h3 id="then-we-process">Then we Process<a class="zola-anchor" href="#then-we-process" aria-label="Anchor link for: then-we-process">ðŸ”—</a></h3>
<p>This is when we cause side-effects to the system.</p>
<p>We want to provide feedback to the user to let them know the results of this process. To keep this simple, we will only consider returning text to the user, as we are providing commands as text. </p>
<p>Our shell process has at least 3 file descriptors for passing input, or receiving output provided. Stdin, Stdout, and Stderr. I need to know how to do that purely with Rust. </p>
<p>After the process is complete, any output should be printed to the screen, via stdout or stderr.</p>
<p>Exit codes will be treated as binary for this exercise. It should be set to 0 if we exit without error. Otherwise the exit code will be 1.</p>
<h3 id="lastly-we-loop">Lastly, we Loop<a class="zola-anchor" href="#lastly-we-loop" aria-label="Anchor link for: lastly-we-loop">ðŸ”—</a></h3>
<p>Return of control will go back to the user. The default user prompt will print as a visual cue (along with the typical blinking cursor) and we should be able to enter another command. </p>
<h2 id="the-coding-strategy">The coding strategy<a class="zola-anchor" href="#the-coding-strategy" aria-label="Anchor link for: the-coding-strategy">ðŸ”—</a></h2>
<p>So then we're running commands. Let's review the strategy. </p>
<ul>
<li>I need to know how to take input command in a loop. </li>
<li>I need to process the input to separate the keyword from the arguments </li>
<li>I need a way to call both builtins and executables. </li>
<li>The most abstract : I need to give the user feedback about the command run. (E. g. Print onto screen as appropriate and set an exit code of the command.) </li>
</ul>
<p>In the next post, we'll dive into using <code>cargo</code> and  start writing in Rust. </p>

</div>

<div class="blog-nav-footer">
    <hr/>
    
    
</div>

  </div>

</body>

</html>