<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
How to prevent Github Actions from deploying on PR with CI&#x2F;CD &middot; T.J. Telan
</title>

  <!-- CSS -->
  <link rel="stylesheet" href="https://tjtelan.com/print.css" media="print">
  <link rel="stylesheet" href="https://tjtelan.com/tj.css">
  <!--<link rel="stylesheet" href="https://tjtelan.com/newsletter.css">-->
  <link rel="stylesheet" href="https://tjtelan.com/hyde.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

  
  
  <link rel="alternate" type="application/atom+xml" title="Atom" href="https://tjtelan.com/atom.xml">
  
  
  
  <!-- Facebook open graph tags-->
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://tjtelan.com/blog/github-actions-push-vs-pr-workflow/" />
   
  <meta property="og:title" content="How to prevent Github Actions from deploying on PR with CI&#x2F;CD" />
  
  
  <meta property="og:description" content="Walkthrough of an example Github Actions workflow that allows different steps for Push vs Pull Requests" />
  
  <!-- Twitter card tags -->
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:url" content="https://tjtelan.com/blog/github-actions-push-vs-pr-workflow/" />
   
  <meta name="twitter:title" content="How to prevent Github Actions from deploying on PR with CI&#x2F;CD" />
  
  
  <meta name="twitter:description" content="Walkthrough of an example Github Actions workflow that allows different steps for Push vs Pull Requests" />
  
  <meta name="twitter:creator" content="@ThatTJTelan" />
  <meta name="twitter:site" content="@ThatTJTelan" />

  
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-M280GK01DY"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-M280GK01DY');
</script>


<!-- Plausible Analytics -->
<script defer data-domain="tjtelan.com" src="https://analytics.analogorithm.net/js/script.js"></script>

</head>

<body class=" ">
  
  <div  id="sidebar" class="sidebar">
    <div class="container sidebar-sticky">
      <div class="sidebar-about">
        
        <a href="https://tjtelan.com">
          <h1>T.J. Telan</h1>
        </a>
        
        <p class="lede">Practical DevOps &amp; Developer Experience</p>
        
        
      </div>

      <ul class="sidebar-nav">
        
          
            
            <li class="sidebar-nav-item">
              <a href="/now/">Now</a>
            </li>
            
          
            
            <li class="sidebar-nav-item">
              <a href="/about/">About</a>
            </li>
            
          
            
            <li class="sidebar-nav-item">
              <a href="https://github.com/tjtelan">Github<img src="/nav-icons/github.svg" alt="Github"></a>
            </li>
            
          
            
            <li class="sidebar-nav-item">
              <a href="https://dev.to/tjtelan">Dev.to<img src="/nav-icons/dev-dot-to.svg" alt="Dev.to"></a>
            </li>
            
          
            
            <li class="sidebar-nav-item">
              <a href="https://medium.com/@tjtelan">Medium<img src="/nav-icons/medium.svg" alt="Medium"></a>
            </li>
            
          
            
            <li class="sidebar-nav-item">
              <a href="https://twitter.com/ThatTJTelan">Twitter<img src="/nav-icons/twitter.svg" alt="Twitter"></a>
            </li>
            
          
            
            <li class="sidebar-nav-item">
              <a href="https://www.twitch.tv/tjtelan">Twitch<img src="/nav-icons/twitch.svg" alt="Twitch"></a>
            </li>
            
          
            
            <li class="sidebar-nav-item">
              <a href="https://www.youtube.com/channel/UCiwV2NFMF26A5nfakQbuZ-g">YouTube<img src="/nav-icons/youtube.svg" alt="YouTube"></a>
            </li>
            
          
            
            <li class="sidebar-nav-item">
              <a href="/atom.xml">RSS<img src="/nav-icons/rss.svg" alt="RSS"></a>
            </li>
            
          
        
      </ul>
    </div>
  </div>
  

  <div class="content container">
    
<div class="post">
    <h1 class="post-title">How to prevent Github Actions from deploying on PR with CI&#x2F;CD</h1>
    
    <span class="post-meta">
        5 min read
        &nbsp;&bull;&nbsp;
        2020-06-12
        
          &nbsp;&bull;
          
          &nbsp;
          <a  href="https://tjtelan.com/categories/how-to/">
              how-to
            </a>
          
          &nbsp;
          <a  href="https://tjtelan.com/categories/devops/">
              devops
            </a>
          
        
        
          &nbsp;&bull;
          
          &nbsp;
          <a  href="https://tjtelan.com/tags/github/">
              #github
            </a>
          
          &nbsp;
          <a  href="https://tjtelan.com/tags/github-actions/">
              #github-actions
            </a>
          
          &nbsp;
          <a  href="https://tjtelan.com/tags/ci/">
              #ci
            </a>
          
          &nbsp;
          <a  href="https://tjtelan.com/tags/cd/">
              #cd
            </a>
          
        
      </span>

    <h2 id="my-experience-using-github-actions-for-ci-cd-as-a-solo-contributor">My experience using Github Actions for CI/CD as a solo contributor<a class="zola-anchor" href="#my-experience-using-github-actions-for-ci-cd-as-a-solo-contributor" aria-label="Anchor link for: my-experience-using-github-actions-for-ci-cd-as-a-solo-contributor">üîó</a></h2>
<p>I am using Github Actions to build and deploy my website when I push. That is a classic continuous integration / continuous deployment workflow. It‚Äôs convenient to commit, push and have my site build and deploy as a result. This workflow is simple but only works because I am the only contributor.</p>
<h2 id="github-actions-for-ci-cd-with-pull-request">Github Actions for CI/CD with Pull Request<a class="zola-anchor" href="#github-actions-for-ci-cd-with-pull-request" aria-label="Anchor link for: github-actions-for-ci-cd-with-pull-request">üîó</a></h2>
<p>It is a good practice to run sanity checks on pull requests prior to merging. How would that be accomplished with Github Actions?</p>
<p>It turns out that you can do this but you need to be very intentional with how your jobs are configured.</p>
<p>In my workflow, I am designating a main branch <code>main</code> that will run full CI/CD. Build, test and deploy. And for any other branch, just build and test.</p>
<p>I‚Äôll share my example Github Actions workflow file, then I‚Äôll provide a template that you can modify and use for your own purposes.</p>
<h2 id="my-example-github-actions-workflow">My example Github Actions workflow<a class="zola-anchor" href="#my-example-github-actions-workflow" aria-label="Anchor link for: my-example-github-actions-workflow">üîó</a></h2>
<p>Here‚Äôs my site‚Äôs current workflow file for Github Actions. I‚Äôll break this down.</p>
<pre data-lang="yaml" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-yaml "><code class="language-yaml" data-lang="yaml"><span style="color:#569cd6;">on</span><span>:
</span><span>  </span><span style="background-color:#282828;color:#569cd6;">push</span><span>:
</span><span>    </span><span style="background-color:#282828;color:#569cd6;">branches</span><span>:
</span><span>      - </span><span style="background-color:#282828;color:#d69d85;">main</span><span> 
</span><span>  </span><span style="background-color:#282828;color:#569cd6;">pull_request</span><span>:
</span><span style="background-color:#282828;color:#569cd6;">jobs</span><span>:
</span><span>  </span><span style="background-color:#282828;color:#569cd6;">build</span><span>:
</span><span>    </span><span style="background-color:#282828;color:#569cd6;">runs-on</span><span>: </span><span style="background-color:#282828;color:#d69d85;">ubuntu-latest</span><span>
</span><span>    </span><span style="background-color:#282828;color:#569cd6;">if</span><span>: </span><span style="background-color:#282828;color:#d69d85;">github.ref != &#39;refs/heads/main&#39;</span><span>
</span><span>    </span><span style="background-color:#282828;color:#569cd6;">steps</span><span>:
</span><span>      - </span><span style="background-color:#282828;color:#569cd6;">name</span><span>: </span><span style="color:#d69d85;">&#39;Checkout&#39;
</span><span>        </span><span style="background-color:#282828;color:#569cd6;">uses</span><span>: </span><span style="background-color:#282828;color:#d69d85;">actions/checkout@main</span><span>
</span><span>      - </span><span style="background-color:#282828;color:#569cd6;">name</span><span>: </span><span style="color:#d69d85;">&#39;Build only&#39;
</span><span>        </span><span style="background-color:#282828;color:#569cd6;">uses</span><span>: </span><span style="background-color:#282828;color:#d69d85;">tjtelan/zola-deploy-action@main</span><span>
</span><span>        </span><span style="background-color:#282828;color:#569cd6;">env</span><span>:
</span><span>          </span><span style="background-color:#282828;color:#569cd6;">BUILD_DIR</span><span>: </span><span style="color:#b5cea8;">.
</span><span>          </span><span style="background-color:#282828;color:#569cd6;">TOKEN</span><span>: </span><span style="background-color:#282828;color:#d69d85;">${{ secrets.TOKEN }}</span><span>
</span><span>          </span><span style="background-color:#282828;color:#569cd6;">BUILD_ONLY</span><span>: </span><span style="color:#569cd6;">true
</span><span>  </span><span style="background-color:#282828;color:#569cd6;">build_and_deploy</span><span>:
</span><span>    </span><span style="background-color:#282828;color:#569cd6;">runs-on</span><span>: </span><span style="background-color:#282828;color:#d69d85;">ubuntu-latest</span><span>
</span><span>    </span><span style="background-color:#282828;color:#569cd6;">if</span><span>: </span><span style="background-color:#282828;color:#d69d85;">github.ref == &#39;refs/heads/main&#39;</span><span>
</span><span>    </span><span style="background-color:#282828;color:#569cd6;">steps</span><span>:
</span><span>      - </span><span style="background-color:#282828;color:#569cd6;">name</span><span>: </span><span style="color:#d69d85;">&#39;Checkout&#39;
</span><span>        </span><span style="background-color:#282828;color:#569cd6;">uses</span><span>: </span><span style="background-color:#282828;color:#d69d85;">actions/checkout@main</span><span>
</span><span>      - </span><span style="background-color:#282828;color:#569cd6;">name</span><span>: </span><span style="color:#d69d85;">&#39;Build and deploy&#39;
</span><span>        </span><span style="background-color:#282828;color:#569cd6;">uses</span><span>: </span><span style="background-color:#282828;color:#d69d85;">tjtelan/zola-deploy-action@main</span><span>
</span><span>        </span><span style="background-color:#282828;color:#569cd6;">env</span><span>:
</span><span>          </span><span style="background-color:#282828;color:#569cd6;">PAGES_BRANCH</span><span>: </span><span style="background-color:#282828;color:#d69d85;">gh-pages</span><span> 
</span><span>          </span><span style="background-color:#282828;color:#569cd6;">BUILD_DIR</span><span>: </span><span style="color:#b5cea8;">.
</span><span>          </span><span style="background-color:#282828;color:#569cd6;">TOKEN</span><span>: </span><span style="background-color:#282828;color:#d69d85;">${{ secrets.TOKEN }}</span><span>
</span></code></pre>
<p>At the top, I am specifying the events that I want to trigger on with the <code>on</code> top-level key.</p>
<pre data-lang="yaml" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-yaml "><code class="language-yaml" data-lang="yaml"><span style="color:#569cd6;">on</span><span>:
</span><span>  </span><span style="background-color:#282828;color:#569cd6;">push</span><span>:
</span><span>    </span><span style="background-color:#282828;color:#569cd6;">branches</span><span>:
</span><span>      - </span><span style="background-color:#282828;color:#d69d85;">main</span><span> 
</span><span>  </span><span style="background-color:#282828;color:#569cd6;">pull_request</span><span>:
</span></code></pre>
<p>I want to trigger on push events to the <code>main</code> branch, and all pull requests.</p>
<p>Later below are 2 jobs that are almost identical. I‚Äôll break them down one at a time then compare their differences.</p>
<p><code>build</code> job </p>
<pre data-lang="yaml" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-yaml "><code class="language-yaml" data-lang="yaml"><span>  </span><span style="background-color:#282828;color:#569cd6;">build</span><span>:
</span><span>    </span><span style="background-color:#282828;color:#569cd6;">runs-on</span><span>: </span><span style="background-color:#282828;color:#d69d85;">ubuntu-latest</span><span>
</span><span>    </span><span style="background-color:#282828;color:#569cd6;">if</span><span>: </span><span style="background-color:#282828;color:#d69d85;">github.ref != &#39;refs/heads/main&#39;</span><span>
</span><span>    </span><span style="background-color:#282828;color:#569cd6;">steps</span><span>:
</span><span>      - </span><span style="background-color:#282828;color:#569cd6;">name</span><span>: </span><span style="color:#d69d85;">&#39;Checkout&#39;
</span><span>        </span><span style="background-color:#282828;color:#569cd6;">uses</span><span>: </span><span style="background-color:#282828;color:#d69d85;">actions/checkout@main</span><span>
</span><span>      - </span><span style="background-color:#282828;color:#569cd6;">name</span><span>: </span><span style="color:#d69d85;">&#39;Build only&#39;
</span><span>        </span><span style="background-color:#282828;color:#569cd6;">uses</span><span>: </span><span style="background-color:#282828;color:#d69d85;">tjtelan/zola-deploy-action@main</span><span>
</span><span>        </span><span style="background-color:#282828;color:#569cd6;">env</span><span>:
</span><span>          </span><span style="background-color:#282828;color:#569cd6;">BUILD_DIR</span><span>: </span><span style="color:#b5cea8;">.
</span><span>          </span><span style="background-color:#282828;color:#569cd6;">TOKEN</span><span>: </span><span style="background-color:#282828;color:#d69d85;">${{ secrets.TOKEN }}</span><span>
</span><span>          </span><span style="background-color:#282828;color:#569cd6;">BUILD_ONLY</span><span>: </span><span style="color:#569cd6;">true
</span></code></pre>
<ol>
<li>This job uses the <code>ubuntu-latest</code> github hosted runner as my environment.</li>
<li>I do a check for the git ref via the <code>github.ref</code> key. Or another way to say this is I check that the working branch that triggered this job is not the <code>main</code> branch. I‚Äôll continue forward only if this condition is <code>true</code>.</li>
<li>Lastly are my steps. I use the <code>actions/checkout@main</code> marketplace action to check my code out, and I use my fork of an action for Zola called <code>tjtelan/zola-deploy-action@main</code>. I have an environment variable <code>BUILD_ONLY</code> set to <code>true</code> which results in building my site but not deploying it.</li>
</ol>
<p><code>build_and_deploy</code> job</p>
<pre data-lang="yaml" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-yaml "><code class="language-yaml" data-lang="yaml"><span>  </span><span style="background-color:#282828;color:#569cd6;">build_and_deploy</span><span>:
</span><span>    </span><span style="background-color:#282828;color:#569cd6;">runs-on</span><span>: </span><span style="background-color:#282828;color:#d69d85;">ubuntu-latest</span><span>
</span><span>    </span><span style="background-color:#282828;color:#569cd6;">if</span><span>: </span><span style="background-color:#282828;color:#d69d85;">github.ref == &#39;refs/heads/main&#39;</span><span>
</span><span>    </span><span style="background-color:#282828;color:#569cd6;">steps</span><span>:
</span><span>      - </span><span style="background-color:#282828;color:#569cd6;">name</span><span>: </span><span style="color:#d69d85;">&#39;Checkout&#39;
</span><span>        </span><span style="background-color:#282828;color:#569cd6;">uses</span><span>: </span><span style="background-color:#282828;color:#d69d85;">actions/checkout@main</span><span>
</span><span>      - </span><span style="background-color:#282828;color:#569cd6;">name</span><span>: </span><span style="color:#d69d85;">&#39;Build and deploy&#39;
</span><span>        </span><span style="background-color:#282828;color:#569cd6;">uses</span><span>: </span><span style="background-color:#282828;color:#d69d85;">tjtelan/zola-deploy-action@main</span><span>
</span><span>        </span><span style="background-color:#282828;color:#569cd6;">env</span><span>:
</span><span>          </span><span style="background-color:#282828;color:#569cd6;">PAGES_BRANCH</span><span>: </span><span style="background-color:#282828;color:#d69d85;">gh-pages</span><span> 
</span><span>          </span><span style="background-color:#282828;color:#569cd6;">BUILD_DIR</span><span>: </span><span style="color:#b5cea8;">.
</span><span>          </span><span style="background-color:#282828;color:#569cd6;">TOKEN</span><span>: </span><span style="background-color:#282828;color:#d69d85;">${{ secrets.TOKEN }}</span><span>
</span></code></pre>
<ol>
<li>This job also uses the <code>ubuntu-latest</code> github hosted runner as my environment.</li>
<li>I do a similar check for the git ref via the <code>github.ref</code> key. This time I am looking for the working branch to be <code>main</code></li>
<li>Lastly are my steps. Same as the previous job, but I am configuring <code>tjtelan/zola-deploy-action@main</code> differently. Rather than setting <code>BUILD_ONLY</code>, I am defining <code>PAGES_BRANCH</code> to <code>gh-pages</code>, which is where I want to deploy my site code after build.</li>
</ol>
<h2 id="last-words-on-job-differences">Last words on job differences<a class="zola-anchor" href="#last-words-on-job-differences" aria-label="Anchor link for: last-words-on-job-differences">üîó</a></h2>
<p>The only differences are the branch check via <code>github.ref</code>, and the specifics of <code>steps</code>. I happen to be using my own Github Action <code>tjtelan/zola-deploy-action</code> but your steps could consist of anything you want to do differently between pull requests and push to your ‚Äúspecial‚Äù branch.</p>
<h2 id="github-actions-template">Github Actions template<a class="zola-anchor" href="#github-actions-template" aria-label="Anchor link for: github-actions-template">üîó</a></h2>
<pre data-lang="yaml" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-yaml "><code class="language-yaml" data-lang="yaml"><span style="color:#569cd6;">on</span><span>:
</span><span>  </span><span style="background-color:#282828;color:#569cd6;">push</span><span>:
</span><span>    </span><span style="background-color:#282828;color:#569cd6;">branches</span><span>:
</span><span>      - </span><span style="background-color:#282828;color:#d69d85;">main</span><span>
</span><span>  </span><span style="background-color:#282828;color:#569cd6;">pull_request</span><span>:
</span><span style="background-color:#282828;color:#569cd6;">jobs</span><span>:
</span><span>  </span><span style="background-color:#282828;color:#569cd6;">build</span><span>:
</span><span>    </span><span style="background-color:#282828;color:#569cd6;">runs-on</span><span>: </span><span style="background-color:#282828;color:#d69d85;">ubuntu-latest</span><span>
</span><span>    </span><span style="background-color:#282828;color:#569cd6;">if</span><span>: </span><span style="background-color:#282828;color:#d69d85;">github.ref != &#39;refs/heads/main</span><span>
</span><span>    </span><span style="background-color:#282828;color:#569cd6;">steps</span><span>:
</span><span>      - </span><span style="background-color:#282828;color:#569cd6;">name</span><span>: </span><span style="color:#d69d85;">&#39;Checkout&#39;
</span><span>        </span><span style="background-color:#282828;color:#569cd6;">uses</span><span>: </span><span style="background-color:#282828;color:#d69d85;">actions/checkout@main</span><span>
</span><span>  </span><span style="background-color:#282828;color:#569cd6;">build_and_deploy</span><span>:
</span><span>    </span><span style="background-color:#282828;color:#569cd6;">runs-on</span><span>: </span><span style="background-color:#282828;color:#d69d85;">ubuntu-latest</span><span>
</span><span>    </span><span style="background-color:#282828;color:#569cd6;">if</span><span>: </span><span style="background-color:#282828;color:#d69d85;">github.ref == &#39;refs/heads/main</span><span>
</span><span>    </span><span style="background-color:#282828;color:#569cd6;">steps</span><span>:
</span><span>      - </span><span style="background-color:#282828;color:#569cd6;">name</span><span>: </span><span style="color:#d69d85;">&#39;Checkout&#39;
</span><span>        </span><span style="background-color:#282828;color:#569cd6;">uses</span><span>: </span><span style="background-color:#282828;color:#d69d85;">actions/checkout@main</span><span>
</span></code></pre>
<p>Here‚Äôs a template that you can use for your own push vs PR workflows. By default, I assume <code>main</code> as the special branch, so you‚Äôll need to change that if you want to use a different branch. Additionally, you‚Äôll need to provide all the steps to take after checking code out.</p>
<h3 id="sources">Sources<a class="zola-anchor" href="#sources" aria-label="Anchor link for: sources">üîó</a></h3>
<ul>
<li><a rel="noopener nofollow" target="_blank" href="https://github.community/t/how-to-trigger-an-action-on-push-or-pull-request-but-not-both/16662/3">Github Community question: How to trigger an action on push or pull request but not both?</a></li>
<li><a rel="noopener nofollow" target="_blank" href="https://help.github.com/en/actions/reference/events-that-trigger-workflows">Github Actions reference: Events that trigger workflows</a> </li>
<li><a rel="noopener nofollow" target="_blank" href="https://help.github.com/en/actions/reference/virtual-environments-for-github-hosted-runners">Github Actions reference: Virtual Environments for Github-hosted runners</a></li>
<li><a rel="noopener nofollow" target="_blank" href="https://help.github.com/en/actions/reference/context-and-expression-syntax-for-github-actions#github-context">Github Actions reference: Context and expression syntax - Github context</a></li>
</ul>

</div>

<div class="blog-nav-footer">
    <hr/>
    
    
</div>

  </div>

</body>

</html>